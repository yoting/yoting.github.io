---
layout: post
title: Zookeeper原理和基本概念
date: 2019-02-120
categories: overall
tags: zookeeper
---

本文主要讲述zookeeper的实现原理以及一些基础概念。

- **zookeeper数据结构：**

  - 采用了类似文件系统的层级树状结构进行管理。

    ![zookeeper](/assets/yoting/post/overall/zookeeper1.jpg)

  - 树状结构中的每个节点被称为znode。znode中可以保存数据，znode节点存储的数据为字节数组。存储数据的格式zookeeper不做限制，也不提供解析，需要应用自己实现。

  - znode节点分为持久节点和临时节点，持久节点只能通过delete删除。临时节点在创建该节点的客户端崩溃或关闭时，自动被删除。

  - znode节点还可以被设置为有序节点，有序znode节点被分配唯一单调递增的证书，通过这种方式，可以创建唯一名称znode，并且可以直观的看到创建的顺序。

  - 可以对节点进行各种操作，包括创建create、删除delete、获取节点数据get、设置节点数据set，查看节点子节点ls等。

  - 每个znode都有版本号，随着每次数据变化自增。setData和delete，以版本号作为参数，当传入的版本号和服务器上不一致时，调用失败。当多个zookeeper客户端同时对一个znode操作时，版本将会起到作用，假设c1，c2同时往一个znode写数据，c1先写完后版本从1升为2，但是c2写的时候携带版本号1，c2会写入失败。

- **zookeeper事件监听机制：**

  - 分布式应用需要及时知道zookeeper中znode的变化，从而了解到分布式应用整体的状况，如果采用轮询方式代价太大，绝大多数查询都是无效的。因此，**zookeeper采用了通知的机制**。
  - 一个节点可以注册一个或多个监听器（观察点watcher），当该znode发生变化时，会触发zookeeper的通知，客户端收到通知后进行业务处理。
  - 一个客户端可以对一个节点进行多次监听，包括通过getData和exist等多种方式设置，但是一个客户端只会收到一次通知。
  - 多个客户都可以对一个节点进行监听，需要通知是会通知到各个客户端。
  - 监听一个不存在的节点是没有意义的，所以在create上设置监听会异常。
  - zookeeper中并没有“永久监听”这种机制。设置监听后通知一次就失效，需要再次设置。但是可以通过编程技巧实现“永久监听”。

- **zookeeper只能保证最终一致性，不能保证强一致性**：

  - 客户端向zookeeper请求，在特定的znode设置观察点（watcher）。当该znode发生变化时，会触发zookeeper的通知，客户端收到通知后进行业务处理。观察点触发后立即失效。所以一旦观察点触发，需要再次设置新的观察点。
  
  - 观察点触发就失效后，需要再次设置观察点，这期间节点可能又有变化，但是客户端还没再次设置观察点，就会导致中间的变化未收到，所以就可能导致数据不一致。为了解决这个问题，客户端在设置新监视点前读取原来节点的数据，进行对比，发现更新，这样就保证了最终节点数据是一致的。
  
- **集群节点个数为奇数：**

  - 防脑裂：zookeeper的选举策略也是需要半数以上的节点同意才能当选leader，如果是偶数节点可能导致票数相同的情况；在节点数量是奇数个的情况下， zookeeper集群总能对外提供服务（即使损失了一部分节点）；如果节点数量是偶数个，会存在zookeeper集群不能用的可能性（脑裂成两个均等的子集群的时候）。

  - 容错：zookeeper集群一大特性是只要集群中半数以上的节点存活，集群就可以正常提供服务，而2n+1台和2n+2台机器的容灾能力相同，都是允许n台机器宕机。本着节约的宗旨，一般选择部署2n+1台机器。

- **集群实例类型（角色）：**

  - leader总统（有且仅有一个）、follower议员（可以有多个）、observer观察者（可以有多个）
  - 当leader实例宕机后，其他的follower实例会重新选举一个节点为leader
  - observer是不参与投票选举的follower的实例，目的是让整个集群更有效率同时又支持多个监听对象。

- **集群实例状态：**

  - LOOKING：寻找Leader状态，处于该状态需要进入选举流程
  - LEADING：领导者状态，处于该状态的节点说明是角色已经是Leader
  - FOLLOWING：跟随者状态，表示Leader已经选举出来，当前节点角色是follower
  - OBSERVER：观察者状态，表明当前节点角色是observer
    